import React from 'react';
import Shield from './Shield';
import SeverityStatCard from './SeverityStatCard';
import AlertsTable from './AlertsTable';
import Section from './Section';
import type { Alert } from '../types/security';
import {
  IoBug as IconBug,
  IoCodeSlash as IconCode,
  IoKey as IconKey,
  IoShieldCheckmark as IconShield
} from 'react-icons/io5';

interface VulnerabilityData {
  dependabot: any[];
  codeScanning: any[];
  secretScanning: any[];
  totalCount: number;
  severity: {
    critical: number;
    high: number;
    medium: number;
    low: number;
  };
  trend?: {
    recentlyAdded: number;
    recentlyClosed: number;
    recentlyClosedDependabot: number;
    recentlyClosedCodeScanning: number;
    totalClosed: number;
    addedBySeverity: {
      critical: number;
      high: number;
      medium: number;
      low: number;
    };
    closedBySeverity: {
      critical: number;
      high: number;
      medium: number;
      low: number;
    };
    deltaBySeverity: {
      critical: number;
      high: number;
      medium: number;
      low: number;
    };
  };
  error?: string;
}

interface VulnerabilityBreakdownProps {
  data: VulnerabilityData;
  projectName: string;
  githubUrl: string;
  className?: string;
}

/**
 * Displays GitHub security alerts breakdown with severity categorization
 */
export default function VulnerabilityBreakdown({
  data,
  projectName,
  githubUrl,
  className = ''
}: VulnerabilityBreakdownProps) {
  const { dependabot, codeScanning, secretScanning, totalCount, severity, trend, error } = data;

  // Transform Dependabot alerts to Alert[]
  const dependabotAlerts: Alert[] = dependabot.map(alert => {
    const hasGhsa = !!alert.security_advisory?.ghsa_id;
    const hasCve = !!alert.security_advisory?.cve_id;

    // If both GHSA and CVE exist, only show GHSA
    const references = [];
    if (hasGhsa) {
      references.push({
        label: alert.security_advisory.ghsa_id,
        url: `https://github.com/advisories/${alert.security_advisory.ghsa_id}`
      });
    } else if (hasCve) {
      references.push({
        label: alert.security_advisory.cve_id,
        url: `https://nvd.nist.gov/vuln/detail/${alert.security_advisory.cve_id}`
      });
    }

    return {
      type: 'dependabot' as const,
      severity: (alert.security_advisory?.severity?.toLowerCase() || 'low') as any,
      title: alert.security_advisory?.summary || alert.security_vulnerability?.package?.name || 'Dependency vulnerability',
      references
    };
  });

  // Transform Code Scanning alerts to Alert[]
  const codeScanningAlerts: Alert[] = codeScanning.map(alert => ({
    type: 'code-scanning' as const,
    severity: (alert.rule?.security_severity_level?.toLowerCase() || 'low') as any,
    title: alert.rule?.description || alert.rule?.name || 'Code scanning alert',
    location: alert.most_recent_instance?.location?.path
  }));

  // Transform Secret Scanning alerts to Alert[]
  const secretScanningAlerts: Alert[] = secretScanning.map(alert => ({
    type: 'secret-scanning' as const,
    severity: 'high' as const,
    title: alert.secret_type_display_name || alert.secret_type || 'Exposed secret',
    location: alert.locations?.[0]?.details?.path
  }));

  if (error === 'GITHUB_TOKEN not configured') {
    return (
      <div className={`border border-gray-300 rounded p-4 ${className}`}>
        <div className="flex items-center gap-2 mb-2">
          <IconShield className="w-5 h-5 text-gray-400" />
          <h4 className="font-semibold text-gray-700">GitHub Security Alerts</h4>
        </div>
        <p className="text-sm text-gray-600">
          GitHub security alerts require API access. Set <code className="bg-gray-100 px-1 rounded">GITHUB_TOKEN</code> environment variable to view data.
        </p>
      </div>
    );
  }

  const hasNoAlerts = totalCount === 0;

  return (
    <div className={`border border-gray-300 rounded p-4 ${className}`}>
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <IconShield className={`w-5 h-5 ${hasNoAlerts ? 'text-green-600' : 'text-gray-700'}`} />
          <h4 className="font-semibold text-gray-700">GitHub Security Alerts</h4>
        </div>
        <a
          href={`${githubUrl}/security`}
          target="_blank"
          rel="noopener noreferrer"
          className="text-xs text-blue-600 hover:underline"
        >
          View on GitHub →
        </a>
      </div>

      {hasNoAlerts ? (
        <div className="bg-green-50 border border-green-200 rounded p-3 mb-3">
          <p className="text-sm text-green-800 font-medium">
            ✓ No open security alerts
          </p>
          <p className="text-xs text-green-700 mt-1">
            {projectName} currently has no open Dependabot, Code Scanning, or Secret Scanning alerts.
          </p>
        </div>
      ) : (
        <>
          {/* Severity Breakdown with Trends */}
          <Section variant="metric-grid" columns={4} className="mb-4 my-0">
            <SeverityStatCard
              color="red"
              value={severity.critical}
              label="Critical"
              trend={trend ? {
                added: trend.addedBySeverity.critical,
                closed: trend.closedBySeverity.critical,
                delta: trend.deltaBySeverity.critical
              } : undefined}
              downIsGood={true}
            />
            <SeverityStatCard
              color="orange"
              value={severity.high}
              label="High"
              trend={trend ? {
                added: trend.addedBySeverity.high,
                closed: trend.closedBySeverity.high,
                delta: trend.deltaBySeverity.high
              } : undefined}
              downIsGood={true}
            />
            <SeverityStatCard
              color="yellow"
              value={severity.medium}
              label="Medium"
              trend={trend ? {
                added: trend.addedBySeverity.medium,
                closed: trend.closedBySeverity.medium,
                delta: trend.deltaBySeverity.medium
              } : undefined}
              downIsGood={true}
            />
            <SeverityStatCard
              color="blue"
              value={severity.low}
              label="Low"
              trend={trend ? {
                added: trend.addedBySeverity.low,
                closed: trend.closedBySeverity.low,
                delta: trend.deltaBySeverity.low
              } : undefined}
              downIsGood={true}
            />
          </Section>

          {/* Alert Type Breakdown */}
          <div className="space-y-4">
            {/* Dependabot Alerts */}
            {dependabotAlerts.length > 0 && (
              <div className="border-t border-gray-200 pt-3">
                <div className="flex items-center gap-2 mb-2">
                  <IconBug className="w-4 h-4 text-gray-600" />
                  <span className="text-sm font-medium text-gray-700">Dependabot Alerts ({dependabotAlerts.length})</span>
                </div>
                <p className="text-xs text-gray-500 mb-2">
                  Automated dependency vulnerability scanning for packages and libraries
                </p>
                <AlertsTable alerts={dependabotAlerts} />
              </div>
            )}

            {/* Code Scanning Alerts */}
            {codeScanningAlerts.length > 0 && (
              <div className="border-t border-gray-200 pt-3">
                <div className="flex items-center gap-2 mb-2">
                  <IconCode className="w-4 h-4 text-gray-600" />
                  <span className="text-sm font-medium text-gray-700">Code Scanning Alerts ({codeScanningAlerts.length})</span>
                </div>
                <p className="text-xs text-gray-500 mb-2">
                  CodeQL analysis for security vulnerabilities and coding errors in source code
                </p>
                <AlertsTable alerts={codeScanningAlerts} />
              </div>
            )}

            {/* Secret Scanning Alerts */}
            {secretScanningAlerts.length > 0 && (
              <div className="border-t border-gray-200 pt-3">
                <div className="flex items-center gap-2 mb-2">
                  <IconKey className="w-4 h-4 text-gray-600" />
                  <span className="text-sm font-medium text-gray-700">Secret Scanning Alerts ({secretScanningAlerts.length})</span>
                </div>
                <p className="text-xs text-gray-500 mb-2">
                  Detection of exposed API keys, tokens, passwords, and other sensitive credentials
                </p>
                <AlertsTable alerts={secretScanningAlerts} />
              </div>
            )}
          </div>
        </>
      )}


    </div>
  );
}
